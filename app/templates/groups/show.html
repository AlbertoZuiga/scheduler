{% extends 'base.html' %}

{% block content %}
<div class="w-full">
  <!-- Page Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold mb-1">{{ group.name }}</h1>
    <p class="text-light-text-secondary dark:text-dark-text-secondary">Gestiona la disponibilidad y categor√≠as del grupo</p>
  </div>

  <!-- Action Buttons -->
  <div class="flex flex-wrap gap-2 mb-6">
    <a href="{{ url_for('groups.index') }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-light-border dark:border-dark-border hover:bg-light-muted/30 dark:hover:bg-dark-muted/30 transition focus:outline-none focus:ring-2 focus:ring-primary">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
      Volver
    </a>
    {% if current_user.id == group.owner_id %}
      <a href="{{ url_for('groups.members', group_id=group.id) }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition focus:outline-none focus:ring-2 focus:ring-blue-400">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        Miembros
      </a>
      <a href="{{ url_for('subgroups.new', group_id=group.id) }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 transition focus:outline-none focus:ring-2 focus:ring-green-400">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
        Divisi√≥n Autom√°tica
      </a>
      <a href="{{ url_for('subgroups.index', group_id=group.id) }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-green-500 text-green-600 hover:bg-green-500 hover:text-white transition focus:outline-none focus:ring-2 focus:ring-green-400">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
        Ver Subgrupos
      </a>
      <form method="POST" action="{{ url_for('groups.delete', group_id=group.id) }}" onsubmit="return confirm('¬øEst√°s seguro de que deseas eliminar este grupo?');" class="inline-block">
        <button type="submit" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition focus:outline-none focus:ring-2 focus:ring-red-400">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
          Eliminar grupo
        </button>
      </form>
    {% elif is_admin %}
      <a href="{{ url_for('groups.members', group_id=group.id) }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition focus:outline-none focus:ring-2 focus:ring-blue-400">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        Miembros
      </a>
      <a href="{{ url_for('subgroups.new', group_id=group.id) }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 transition focus:outline-none focus:ring-2 focus:ring-green-400">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
        Divisi√≥n Autom√°tica
      </a>
      <a href="{{ url_for('subgroups.index', group_id=group.id) }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-green-500 text-green-600 hover:bg-green-500 hover:text-white transition focus:outline-none focus:ring-2 focus:ring-green-400">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
        Ver Subgrupos
      </a>
      <form method="POST" action="{{ url_for('groups.leave', group_id=group.id) }}" onsubmit="return confirm('¬øEst√°s seguro de que deseas abandonar este grupo?');" class="inline-block">
        <button type="submit" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition focus:outline-none focus:ring-2 focus:ring-red-400">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
          Salir del grupo
        </button>
      </form>
    {% else %}
      <a href="{{ url_for('subgroups.index', group_id=group.id) }}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-green-500 text-green-600 hover:bg-green-500 hover:text-white transition focus:outline-none focus:ring-2 focus:ring-green-400">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
        Ver Subgrupos
      </a>
      <form method="POST" action="{{ url_for('groups.leave', group_id=group.id) }}" onsubmit="return confirm('¬øEst√°s seguro de que deseas abandonar este grupo?');" class="inline-block">
        <button type="submit" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition focus:outline-none focus:ring-2 focus:ring-red-400">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
          Salir del grupo
        </button>
      </form>
    {% endif %}
  </div>

{% set weekdays = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"] %}

<div class="mt-6 space-y-6">
  {% if (current_user.id == group.owner_id or is_admin) and availability_data %}
  <section class="space-y-4">
    <details class="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-lg p-4" open>
      <summary class="cursor-pointer font-semibold">Horarios en los que pueden todos</summary>
      <ul class="mt-3 list-disc list-inside text-sm text-light-text-secondary dark:text-dark-text-secondary">
        {% for availability_id, data in availability_data.items() %}
          {% if data.count_users == user_info_map|length %}
            <li>{{ weekdays[data.availability.weekday] }} {{ convert_float_to_time_string(data.availability.hour) }}</li>
          {% endif %}
        {% endfor %}
      </ul>
    </details>
    <details class="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-lg p-4">
      <summary class="cursor-pointer font-semibold">Horarios en los que no pueden todos</summary>
      <div class="mt-3 space-y-3">
        {% for availability_id, data in availability_data.items() %}
          {% if data.count_users < user_info_map|length %}
          <details class="bg-light-surface dark:bg-dark-surface border border-light-border dark:border-dark-border rounded p-3">
            <summary class="cursor-pointer text-sm">
              {{ weekdays[data.availability.weekday] }} {{ convert_float_to_time_string(data.availability.hour) }} ‚Äî {{ data.count_users }} {{ "personas disponibles" if data.count_users > 1 else "persona disponible" }}
            </summary>
            <ul class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
              {% for user_id in data.users %}
                {% if user_id in user_info_map %}
                <li>
                  <span class="inline-block text-xs px-2 py-1 rounded bg-light-muted/40 dark:bg-dark-muted/40">{{ user_info_map[user_id].name }} {{ user_info_map[user_id].email }}</span>
                </li>
                {% endif %}
              {% endfor %}
            </ul>
          </details>
          {% endif %}
        {% endfor %}
      </div>
    </details>
  </section>
  {% endif %}

  <a href="{{ url_for('groups.availability', group_id=group.id) }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-primary text-primary hover:bg-primary hover:text-white transition focus:outline-none focus:ring-2 focus:ring-primary">üìù Editar disponibilidad</a>

  <div class="overflow-x-auto">
    <table class="w-full text-center align-middle border-collapse">
      <thead>
        <tr class="bg-light-muted/30 dark:bg-dark-muted/30">
          <th class="px-3 py-2 border border-light-border dark:border-dark-border">Bloque</th>
          {% for day in weekdays %}
            <th class="px-3 py-2 border border-light-border dark:border-dark-border">{{ day }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for block in blocks %}
        {% set block_index = loop.index0 %}
        <tr class="odd:bg-light-background even:bg-light-surface dark:odd:bg-dark-background dark:even:bg-dark-surface">
          <td class="px-3 py-2 border border-light-border dark:border-dark-border text-sm">{{ block }}</td>
          {% for day_index in range(0, 7) %}
          <td class="px-3 py-2 border border-light-border dark:border-dark-border align-top">
            <div class="space-y-1">
            {% if current_user.id == group.owner_id or is_admin %}
              {% for user_id, weekday, hour in availability %}
                {% if (weekday, blocks[hour|int - 8]) == (day_index, blocks[block_index]) %}
                  {% set user_name = user_info_map[user_id].name %}
                  {% set color = color_map[user_id] %}
                  <span class="inline-block text-xs px-2 py-0.5 rounded {{ 'bg-blue-500 text-white' if 'bg-primary' in color else 'bg-light-muted/40 dark:bg-dark-muted/40' }}">{{ user_name }}</span>
                {% endif %}
              {% endfor %}
            {% else %}
              {% if (day_index, block) in selected %}
                <span class="inline-block text-xs px-2 py-0.5 rounded bg-primary text-white">Disponible</span>
              {% endif %}
            {% endif %}
            </div>
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<div class="mt-8">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-xl font-bold">Categor√≠as</h3>
    {% if can_manage %}
    <button id="openBulkAssign" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-light-border dark:border-dark-border hover:bg-light-muted/30 dark:hover:bg-dark-muted/30 transition">Asignar en bloque</button>
    {% endif %}
  </div>
  {% if can_manage %}
  <form id="createCategoryForm" class="flex flex-col sm:flex-row gap-2 mb-4" autocomplete="off" novalidate>
    <div class="flex-1">
      <input type="text" id="newCategoryName" class="w-full px-3 py-2 rounded border border-light-border dark:border-dark-border bg-light-background dark:bg-dark-background" placeholder="Nueva categor√≠a (p. ej. Backend, Dise√±o)" required>
      <div id="nameFeedback" class="text-xs mt-1"></div>
    </div>
    <div>
      <button type="submit" class="px-4 py-2 rounded bg-primary text-white disabled:opacity-50" id="createCategoryBtn" disabled>
        Crear categor√≠a
      </button>
    </div>
  </form>
  {% endif %}
  <div id="categoriesList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</div>

{% if can_manage %}
<!-- Modal Asignaci√≥n en bloque (Tailwind) -->
<div id="bulkAssignModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/40" data-close="true"></div>
  <div class="relative mx-auto my-10 w-[95%] max-w-3xl bg-light-card dark:bg-dark-card rounded-xl shadow-lg border border-light-border dark:border-dark-border">
    <div class="flex items-center justify-between px-4 py-3 border-b border-light-border dark:border-dark-border">
      <h5 class="font-bold">Asignar categor√≠as a miembros</h5>
      <button class="p-2 rounded hover:bg-light-muted/30 dark:hover:bg-dark-muted/30" data-close="true" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-[60vh] overflow-auto">
      <div>
        <h6 class="mb-2 font-semibold">Miembros</h6>
        <div id="bulkMembers" class="border border-light-border dark:border-dark-border rounded p-2 space-y-1 max-h-64 overflow-auto"></div>
      </div>
      <div>
        <h6 class="mb-2 font-semibold">Categor√≠as</h6>
        <div id="bulkCategories" class="border border-light-border dark:border-dark-border rounded p-2 space-y-1 max-h-64 overflow-auto"></div>
      </div>
    </div>
    <div class="flex items-center justify-between px-4 py-3 border-t border-light-border dark:border-dark-border">
      <div class="space-x-2">
        <button type="button" class="px-3 py-2 rounded border border-light-border dark:border-dark-border hover:bg-light-muted/30 dark:hover:bg-dark-muted/30" id="selectAllMembers">Todos miembros</button>
        <button type="button" class="px-3 py-2 rounded border border-light-border dark:border-dark-border hover:bg-light-muted/30 dark:hover:bg-dark-muted/30" id="selectAllCategories">Todas categor√≠as</button>
      </div>
      <div class="space-x-2">
        <button type="button" class="px-3 py-2 rounded border border-red-300 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20" id="unassignSelected">Desasignar</button>
        <button type="button" class="px-3 py-2 rounded bg-primary text-white hover:opacity-90" id="assignSelected">Asignar</button>
      </div>
    </div>
  </div>
  <div class="h-10"></div>
</div>
{% endif %}

{% block script %}
{{ super() }}
{% set members_data = [] %}
{% for m in group.members %}
  {% set member_name = m.user.name if m.user.name else m.user.email %}
  {% set _ = members_data.append({
    'group_member_id': m.id,
    'user_id': m.user.id,
    'name': member_name,
    'email': m.user.email
  }) %}
{% endfor %}
{% set embed_data = {
  'group_id': group.id,
  'can_manage': True if can_manage else False,
  'members': members_data
} %}
<script type="application/json" id="embed-data">{{ embed_data | tojson }}</script>

<script>
  globalThis.__EMBED__ = JSON.parse(document.getElementById('embed-data').textContent || '{}');
  globalThis.GROUP_ID = globalThis.__EMBED__.group_id;
  globalThis.CAN_MANAGE = !!globalThis.__EMBED__.can_manage;
  globalThis.__GROUP_MEMBERS__ = globalThis.__EMBED__.members || [];

  function showInlineAlert(message, type = 'success') {
    const container = document.querySelector('main');
    const el = document.createElement('div');
    const styleMap = {
      success: 'bg-green-50 text-green-800 border-green-200',
      danger: 'bg-red-50 text-red-800 border-red-200',
      warning: 'bg-yellow-50 text-yellow-800 border-yellow-200',
      info: 'bg-blue-50 text-blue-800 border-blue-200'
    };
    el.setAttribute('role', 'alert');
    el.className = `flex items-start justify-between gap-4 rounded-lg border px-4 py-3 text-sm ${styleMap[type] || 'bg-light-surface text-light-text-primary border-light-border dark:bg-dark-surface dark:text-dark-text-primary dark:border-dark-border'}`;
    el.innerHTML = `<div>${message}</div><button class="p-1 rounded hover:bg-black/5 dark:hover:bg-white/5" aria-label="Cerrar">‚úï</button>`;
    el.querySelector('button')?.addEventListener('click', () => el.remove());
    container?.prepend(el);
    setTimeout(() => el.remove(), 4000);
  }

  // Helper to resolve group_member id to display name
  function memberNameByGmId(gmId) {
    const m = (globalThis.__GROUP_MEMBERS__ || []).find(x => Number.parseInt(x.group_member_id) === Number.parseInt(gmId));
    return m ? (m.name || m.email) : `Miembro ${gmId}`;
  }

  // Render categories list with member badges
  async function loadCategories() {
  const list = document.getElementById('categoriesList');
  list.innerHTML = '<div class="text-light-text-secondary dark:text-dark-text-secondary">Cargando categor√≠as‚Ä¶</div>';
    try {
      const res = await fetch(`/categories/group/${globalThis.GROUP_ID}`, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('Error al cargar categor√≠as');
      const data = await res.json();
      if (!Array.isArray(data)) { list.innerHTML = '<span class="text-light-text-secondary dark:text-dark-text-secondary">Sin datos</span>'; return; }
      if (data.length === 0) { list.innerHTML = '<span class="text-light-text-secondary dark:text-dark-text-secondary">No hay categor√≠as a√∫n.</span>'; return; }
      list.innerHTML = '';
      for (const c of data) {
        const count = Array.isArray(c.member_ids) ? c.member_ids.length : (c.count || 0);
        const membersHtml = (c.member_ids || []).map(gmId => `<span class="inline-block text-xs rounded px-2 py-1 bg-light-muted/40 dark:bg-dark-muted/40 text-light-text-primary dark:text-dark-text-primary mr-1 mb-1">${memberNameByGmId(gmId)}</span>`).join(' ');

        const card = document.createElement('div');
        card.className = 'bg-light-card dark:bg-dark-card rounded-lg border border-light-border dark:border-dark-border shadow p-4 flex flex-col gap-2';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <h6 class="font-semibold">${c.name}</h6>
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center justify-center w-6 h-6 text-xs rounded-full bg-light-muted/40 dark:bg-dark-muted/40 text-light-text-primary dark:text-dark-text-primary">${count}</span>
              ${globalThis.CAN_MANAGE ? '<button class="px-2 py-1 rounded border border-red-300 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 delete-category-btn">Eliminar</button>' : ''}
            </div>
          </div>
          <div>${membersHtml || '<span class="text-light-text-secondary dark:text-dark-text-secondary">Sin miembros asignados</span>'}</div>`;

        // Add event listener to delete button if user can manage
        if (globalThis.CAN_MANAGE) {
          const deleteBtn = card.querySelector('.delete-category-btn');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', () => deleteCategory(c.id, c.name));
          }
        }
        list.appendChild(card);
      }
    } catch (err) {
      console.error('Error loading categories:', err);
      list.innerHTML = '<span class="text-red-600">Error al cargar categor√≠as</span>';
    }
  }

  // Delete category
  async function deleteCategory(catId, catName) {
    if (!confirm(`¬øEliminar la categor√≠a "${catName}"? Se desasociar√°n todos los miembros.`)) return;
    try {
      const res = await fetch(`/categories/group/${globalThis.GROUP_ID}/${catId}`, { 
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });
      if (res.ok) {
        showInlineAlert(`Categor√≠a "${catName}" eliminada.`, 'success');
        await loadCategories();
      } else {
        const data = await res.json().catch(() => ({}));
        showInlineAlert(data.message || 'No se pudo eliminar la categor√≠a.', 'danger');
      }
    } catch (err) {
      console.error('Error deleting category:', err);
      showInlineAlert('Error al eliminar la categor√≠a.', 'danger');
    }
  }

  // Real-time validation for category name
  var checkTimer = null;
  function setupCategoryCreate() {
    if (!globalThis.CAN_MANAGE) return;
    const input = document.getElementById('newCategoryName');
    const feedback = document.getElementById('nameFeedback');
    const btn = document.getElementById('createCategoryBtn');
    const form = document.getElementById('createCategoryForm');
    
    // Si el formulario ya fue inicializado, no hacer nada
    if (form?.dataset.initialized === 'true') return;
    if (form) form.dataset.initialized = 'true';
    
    const updateBtn = (enabled) => { btn.disabled = !enabled; };
    const validate = async () => {
      const name = (input.value || '').trim();
      if (!name) { feedback.textContent = ''; updateBtn(false); return; }
      const res = await fetch(`/categories/group/${globalThis.GROUP_ID}/check?name=${encodeURIComponent(name)}`);
      const data = await res.json();
      if (data.available) {
        feedback.textContent = 'Disponible';
        feedback.className = 'form-text text-success';
        updateBtn(true);
      } else {
        feedback.textContent = data.message || 'No disponible';
        feedback.className = 'form-text text-danger';
        updateBtn(false);
      }
    };
    input?.addEventListener('input', () => {
      clearTimeout(checkTimer);
      checkTimer = setTimeout(validate, 300);
    });
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = (input.value || '').trim();
      if (!name) { return; }
      const res = await fetch(`/categories/group/${globalThis.GROUP_ID}` , {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      if (res.ok) {
        input.value = '';
        feedback.textContent = '';
        updateBtn(false);
        showInlineAlert('Categor√≠a creada correctamente.','success');
        await loadCategories();
      } else {
        const data = await res.json().catch(() => ({}));
        showInlineAlert(data.message || 'No se pudo crear la categor√≠a.','danger');
      }
    });
  }

  // Bulk assign modal
  function setupBulkAssign() {
    if (!globalThis.CAN_MANAGE) return;
    
    const modal = document.getElementById('bulkAssignModal');
    // Si el modal ya fue inicializado, no hacer nada
    if (modal?.dataset.initialized === 'true') return;
    if (modal) modal.dataset.initialized = 'true';
    
    const membersContainer = document.getElementById('bulkMembers');
    const categoriesContainer = document.getElementById('bulkCategories');
    const btnAssign = document.getElementById('assignSelected');
    const btnUnassign = document.getElementById('unassignSelected');
    const btnAllMembers = document.getElementById('selectAllMembers');
    const btnAllCategories = document.getElementById('selectAllCategories');
    async function populateModal() {
      const members = globalThis.__GROUP_MEMBERS__ || [];
      const categoriesRes = await fetch(`/categories/group/${globalThis.GROUP_ID}`, { headers: { 'Accept': 'application/json' } });
      const categories = await categoriesRes.json();

      membersContainer.innerHTML = '';
      for (const m of members) {
        const item = document.createElement('label');
        item.className = 'flex items-center gap-2 p-2 rounded hover:bg-light-surface dark:hover:bg-dark-surface';
        item.innerHTML = `<input type="checkbox" class="accent-primary" value="${m.group_member_id}"> <span>${m.name} <small class="text-light-text-secondary dark:text-dark-text-secondary">${m.email}</small></span>`;
        membersContainer.appendChild(item);
      }
      categoriesContainer.innerHTML = '';
      for (const c of categories) {
        const item = document.createElement('label');
        item.className = 'flex items-center gap-2 p-2 rounded hover:bg-light-surface dark:hover:bg-dark-surface';
        item.innerHTML = `<input type="checkbox" class="accent-primary" value="${c.id}"> <span>${c.name}</span>`;
        categoriesContainer.appendChild(item);
      }
    }

    const openBtn = document.getElementById('openBulkAssign');
    const closeEls = modal?.querySelectorAll('[data-close="true"]');
    openBtn?.addEventListener('click', async () => {
      await populateModal();
      modal.classList.remove('hidden');
    });
    if (closeEls) {
      for (const btn of closeEls) {
        btn.addEventListener('click', () => modal.classList.add('hidden'));
      }
    }
    modal?.addEventListener('click', (e) => { if (e.target?.dataset?.close === 'true') modal.classList.add('hidden'); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') modal?.classList.add('hidden'); });

  const getCheckedValues = (container) => Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(i => Number.parseInt(i.value));

    btnAllMembers?.addEventListener('click', () => {
    const inputs = membersContainer.querySelectorAll('input[type="checkbox"]');
    const allChecked = Array.from(inputs).every(i => i.checked);
    for (const i of inputs) { i.checked = !allChecked; }
    btnAllMembers.textContent = allChecked ? 'Todos miembros' : 'Deseleccionar todos';
  });

  btnAllCategories?.addEventListener('click', () => {
    const inputs = categoriesContainer.querySelectorAll('input[type="checkbox"]');
    const allChecked = Array.from(inputs).every(i => i.checked);
    for (const i of inputs) { i.checked = !allChecked; }
    btnAllCategories.textContent = allChecked ? 'Todas categor√≠as' : 'Deseleccionar todas';
  });

    async function submitBulk(action) {
      const member_ids = getCheckedValues(membersContainer);
      const category_ids = getCheckedValues(categoriesContainer);
        console.log('submitBulk action:', action, { member_ids, category_ids });
      if (member_ids.length === 0 || category_ids.length === 0) {
        showInlineAlert('Selecciona al menos un miembro y una categor√≠a.', 'warning');
        return;
      }
      try {
        const res = await fetch('/categories/bulk_assign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ group_id: globalThis.GROUP_ID, member_ids, category_ids, action })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.ok) {
          showInlineAlert(action === 'assign' ? 'Asignaci√≥n completada.' : 'Desasignaci√≥n completada.', 'success');
          await loadCategories();
          // Close modal
          document.getElementById('bulkAssignModal')?.classList.add('hidden');
        } else {
          showInlineAlert(data.message || 'Ocurri√≥ un error al procesar la acci√≥n.', 'danger');
        }
      } catch (err) {
        console.error('Error in bulk assign:', err);
        showInlineAlert('Error de red al procesar la acci√≥n.', 'danger');
      }
    }
    btnAssign?.addEventListener('click', () => submitBulk('assign'));
    btnUnassign?.addEventListener('click', () => submitBulk('unassign'));
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadCategories();
    setupCategoryCreate();
    setupBulkAssign();
  });
</script>
{% endblock %}

{% endblock %}